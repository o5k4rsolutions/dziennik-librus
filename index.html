<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dziennik Elektroniczny - Glassmorphism</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: all 0.3s ease-in-out;
        }
        .glass-card:hover {
            box-shadow: 0 10px 40px 0 rgba(31, 38, 135, 0.25);
        }
        .header-bg {
             background: linear-gradient(90deg, #1e3a8a 0%, #10b981 100%);
        }
        .tab-btn { 
            transition: all 0.3s; 
            padding: 0.8rem 1.25rem; 
            border-radius: 1.5rem 1.5rem 0 0;
            margin-right: 0.5rem;
            font-weight: 500;
        }
        .tab-btn.active { 
            background: rgba(255, 255, 255, 0.9);
            color: #1e3a8a;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.08);
            border-bottom: 3px solid #1e3a8a;
            font-weight: 600;
        }
        .input-style { 
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(30, 58, 138, 0.2); 
            border-radius: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s; 
        }
        .input-style:focus { 
            border-color: #10b981; 
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4); 
            background: white;
        }
        .btn-primary { 
            background: #10b981; 
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
            font-weight: 600;
            border-radius: 0.75rem;
        }
        .btn-primary:hover { 
            background: #059669; 
        }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
    </style>
</head>
<body>

    <div id="app" class="p-4 sm:p-10">
        <header class="mb-10 p-5 header-bg text-white shadow-xl rounded-xl">
            <div class="flex justify-between items-center max-w-7xl mx-auto">
                <h1 class="text-3xl font-extrabold tracking-wider">L. Dziennik üß™</h1>
                <div id="authStatus" class="text-xs rounded-full bg-white bg-opacity-20 px-4 py-2 font-medium border border-white border-opacity-30">
                    ≈Åadowanie...
                </div>
            </div>
        </header>

        <div id="loading" class="text-center p-16 text-gray-500 hidden glass-card max-w-lg mx-auto">
            <div class="animate-spin rounded-full h-10 w-10 border-b-3 border-gray-500 inline-block"></div>
            <p class="mt-4 text-xl font-medium">≈Åadowanie danych...</p>
        </div>

        <div id="mainContent" class="hidden max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <!-- Panel ZarzƒÖdzania -->
                <div class="glass-card p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 border-gray-200">Panel ZarzƒÖdzania</h2>
                    <select id="classSelector" class="input-style w-full p-3 border focus:ring-emerald-500 transition duration-150 shadow-sm text-gray-700">
                        <option value="" disabled selected>--- Wybierz Klasƒô ---</option>
                    </select>
                    <div id="classInfo" class="mt-4 p-4 bg-white bg-opacity-70 border-l-4 border-indigo-500 text-sm text-gray-700 hidden rounded-lg">
                        <p>ID Nauczyciela: <span id="userIdDisplay" class="font-mono text-xs text-gray-800 break-all"></span></p>
                    </div>
                </div>

                <!-- Dodaj NowƒÖ Klasƒô -->
                <div class="glass-card p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Utw√≥rz Klasƒô</h2>
                    <input type="text" id="newClassName" placeholder="Nazwa klasy (np. 8a)" class="input-style w-full p-3 border mb-4">
                    <button onclick="addClass()" class="w-full btn-primary text-white py-3 px-4 transition duration-150 hover:shadow-xl">Utw√≥rz Klasƒô</button>
                </div>

                <!-- Edytuj Przedmioty -->
                <div id="subjectManager" class="glass-card p-6 hidden">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Przedmioty Klasy</h2>
                    <div id="currentSubjects" class="mb-4 flex flex-wrap gap-2">
                    </div>
                    <input type="text" id="newSubjectName" placeholder="Nowy przedmiot (np. Chemia)" class="input-style w-full p-3 border mb-4">
                    <button onclick="addSubjectToClass()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-150 hover:shadow-xl">Dodaj Przedmiot</button>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div id="classDetails" class="hidden">
                    <h2 class="text-4xl font-extrabold mb-6 text-gray-800">Klasa: <span id="selectedClassNameDisplay" class="text-indigo-600"></span></h2>
                    
                    <!-- Tabs -->
                    <div class="flex border-b-2 border-gray-200 mb-6">
                        <button id="tabStudents" onclick="showTab('students')" class="tab-btn text-gray-600 active">Lista Uczni√≥w</button>
                        <button id="tabEntry" onclick="showTab('entry')" class="tab-btn text-gray-600">Wpisywanie Danych</button>
                        <button id="tabReports" onclick="showTab('reports')" class="tab-btn text-gray-600">Raporty</button>
                    </div>

                    <div class="glass-card p-8 min-h-[600px]">
                        <!-- Students Tab -->
                        <div id="studentsTab" class="tab-content">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-bold text-gray-700">PrzeglƒÖd Ocen</h3>
                                <button onclick="openAddStudentModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold py-2.5 px-5 rounded-full transition duration-150 shadow-md flex items-center transform hover:scale-[1.02]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                                    Dodaj Ucznia
                                </button>
                            </div>
                            <div id="studentsList" class="overflow-x-auto">
                            </div>
                        </div>

                        <!-- Entry Tab -->
                        <div id="entryTab" class="tab-content hidden">
                            <h3 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">Wpisywanie Ocen i Uwag</h3>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                <div class="p-6 glass-card border border-emerald-400 bg-emerald-50 bg-opacity-70">
                                    <h4 class="text-xl font-bold mb-4 text-emerald-700">Wpisz Ocenƒô üìù</h4>
                                    <select id="gradeStudentSelector" class="input-style w-full p-3 border mb-3"></select>
                                    <select id="gradeSubjectSelector" class="input-style w-full p-3 border mb-3"></select>
                                    
                                    <div class="flex gap-4 mb-4">
                                        <input type="number" id="gradeValue" min="1" max="6" step="0.5" placeholder="Ocena (1-6)" class="input-style w-1/3 p-3 border text-center">
                                        <select id="gradeCategory" class="input-style w-2/3 p-3 border">
                                            <option value="" disabled selected>--- Kategoria ---</option>
                                            <option value="Kartk√≥wka">Kartk√≥wka</option>
                                            <option value="Odpowied≈∫">Odpowied≈∫</option>
                                            <option value="Praca Klasowa">Praca Klasowa</option>
                                            <option value="Aktywno≈õƒá">Aktywno≈õƒá</option>
                                            <option value="Zadanie">Zadanie</option>
                                        </select>
                                    </div>
                                    <textarea id="gradeComment" placeholder="Opcjonalny komentarz..." class="input-style w-full p-3 border mb-4 h-24 resize-none"></textarea>
                                    <button onclick="submitGrade()" class="w-full btn-primary text-white py-3 transition duration-150 hover:shadow-xl">Zapisz Ocenƒô</button>
                                </div>

                                <div class="p-6 glass-card border border-indigo-400 bg-indigo-50 bg-opacity-70">
                                    <h4 class="text-xl font-bold mb-4 text-indigo-700">Wpisz Uwagƒô üîî</h4>
                                    <select id="noteStudentSelector" class="input-style w-full p-3 border mb-3"></select>
                                    <select id="noteType" class="input-style w-full p-3 border mb-3">
                                        <option value="positive">Pozytywna (np. "Aktywno≈õƒá na lekcji")</option>
                                        <option value="negative">Negatywna (np. "Brak pracy domowej")</option>
                                    </select>
                                    <textarea id="noteContent" placeholder="Tre≈õƒá uwagi" class="input-style w-full p-3 border mb-4 h-24 resize-none"></textarea>
                                    <button onclick="submitNote()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition duration-150 hover:shadow-xl">Zapisz Uwagƒô</button>
                                </div>
                            </div>
                        </div>

                        <!-- Reports Tab -->
                        <div id="reportsTab" class="tab-content hidden">
                            <h3 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">Raporty i Historia Ucznia</h3>
                            <p class="text-gray-500 mb-6">Wybierz ucznia, aby zobaczyƒá jego pe≈ÇnƒÖ historiƒô.</p>

                            <select id="reportStudentSelector" class="input-style w-full md:w-1/2 p-3 border mb-8"></select>
                            
                            <div id="studentReportDetails" class="space-y-10">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding student -->
    <div id="addStudentModal" class="fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center hidden z-50 transition-opacity duration-300">
        <div class="glass-card p-8 w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="studentModalContent">
            <h3 class="text-2xl font-bold mb-5 text-gray-800">Dodaj Nowego Ucznia</h3>
            <input type="text" id="newStudentName" placeholder="Imiƒô i Nazwisko (np. Anna Kowalska)" class="input-style w-full p-4 border mb-6">
            <div class="flex justify-end gap-3">
                <button onclick="closeAddStudentModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl transition duration-150">Anuluj</button>
                <button onclick="addStudent()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">Dodaj</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, addDoc, arrayUnion, 
            serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');
        
        const firebaseConfig = {
            apiKey: "AIzaSyAOa8hKqTPvTiSfNsMVbR-bM7ihY7Puzr0",
            authDomain: "dziennik-75ed6.firebaseapp.com",
            projectId: "dziennik-75ed6",
            storageBucket: "dziennik-75ed6.firebasestorage.app",
            messagingSenderId: "521205924518",
            appId: "1:521205924518:web:1f22f45ed6aeb7b6b5aa67",
            measurementId: "G-72D41D7ETD"
        };
        const app = initializeApp(firebaseConfig);

        const APP_ID = 'dziennik-librus-style'; 

        let auth, db;
        let userId = null;
        let isAuthReady = false;
        
        let classes = {}; 
        let selectedClassId = null;
        
        const authStatusEl = document.getElementById('authStatus');
        const mainContentEl = document.getElementById('mainContent');
        const loadingEl = document.getElementById('loading');
        const classSelectorEl = document.getElementById('classSelector');
        const selectedClassNameDisplayEl = document.getElementById('selectedClassNameDisplay');
        const studentsListEl = document.getElementById('studentsList');
        const subjectManagerEl = document.getElementById('subjectManager');
        const classDetailsEl = document.getElementById('classDetails');
        const currentSubjectsEl = document.getElementById('currentSubjects');

        const gradeStudentSelectorEl = document.getElementById('gradeStudentSelector');
        const gradeSubjectSelectorEl = document.getElementById('gradeSubjectSelector');
        const noteStudentSelectorEl = document.getElementById('noteStudentSelector');
        const reportStudentSelectorEl = document.getElementById('reportStudentSelector');
        const studentReportDetailsEl = document.getElementById('studentReportDetails');
        const modalEl = document.getElementById('addStudentModal');
        const modalContentEl = document.getElementById('studentModalContent');

        const initializeFirebase = async () => {
            try {
                db = getFirestore(app);
                auth = getAuth(app);

                loadingEl.classList.remove('hidden');

                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            authStatusEl.textContent = `Zalogowany (ID: ${userId.substring(0, 8)}...)`;
                            authStatusEl.classList.add('bg-white', 'bg-opacity-30');
                            document.getElementById('userIdDisplay').textContent = userId;
                            document.getElementById('classInfo').classList.remove('hidden');
                        } else {
                            await signInAnonymously(auth);
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                if (isAuthReady) {
                    await setupDataListeners();
                    loadingEl.classList.add('hidden');
                    mainContentEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error("B≈ÇƒÖd inicjalizacji Firebase:", error);
                authStatusEl.textContent = `B≈ÇƒÖd Autoryzacji`;
                authStatusEl.classList.remove('bg-white');
                authStatusEl.classList.add('bg-red-500');
            }
        };

        const getPublicCollectionPath = (collectionName) => 
            `artifacts/${APP_ID}/public/data/${collectionName}`;

        const setupDataListeners = async () => {
            if (!isAuthReady || !userId) return;

            const classesRef = collection(db, getPublicCollectionPath('classes'));
            onSnapshot(classesRef, (snapshot) => {
                const newClasses = {};
                snapshot.forEach(doc => {
                    newClasses[doc.id] = { id: doc.id, ...doc.data(), students: {} };
                });
                classes = newClasses;
                
                renderClassSelector();
                
                if (!selectedClassId || !classes[selectedClassId]) {
                    selectedClassId = Object.keys(classes)[0] || null;
                }

                if (selectedClassId) {
                    setupClassSubscribers(selectedClassId);
                    renderClassDetails();
                }
            });
        };

        const setupClassSubscribers = (classId) => {
            const studentsRef = collection(db, getPublicCollectionPath(`classes/${classId}/students`));
            onSnapshot(studentsRef, (snapshot) => {
                if (!classes[classId]) return;
                classes[classId].students = {};
                snapshot.forEach(doc => {
                    classes[classId].students[doc.id] = { id: doc.id, ...doc.data(), grades: [], notes: [] };
                });
                setupStudentSubscribers(classId);
            });
        };

        const setupStudentSubscribers = (classId) => {
            if (!classes[classId]) return;
            Object.values(classes[classId].students).forEach(student => {
                
                const gradesRef = collection(db, getPublicCollectionPath(`classes/${classId}/students/${student.id}/grades`));
                onSnapshot(gradesRef, (snapshot) => {
                    student.grades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    student.grades.sort((a, b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0)); 
                    renderStudentsList();
                    renderEntrySelectors();
                    renderReport();
                });

                const notesRef = collection(db, getPublicCollectionPath(`classes/${classId}/students/${student.id}/notes`));
                onSnapshot(notesRef, (snapshot) => {
                    student.notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    student.notes.sort((a, b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0)); 
                    renderStudentsList();
                    renderEntrySelectors();
                    renderReport();
                });
            });
            renderStudentsList(); 
        }

        window.addClass = async () => {
            const name = document.getElementById('newClassName').value.trim();
            if (!name) return alertModal("Podaj nazwƒô klasy!");

            try {
                const newClassRef = doc(collection(db, getPublicCollectionPath('classes')));
                await setDoc(newClassRef, {
                    name,
                    subjects: ["Matematyka", "Jƒôzyk Polski", "Jƒôzyk Angielski"],
                    createdAt: serverTimestamp(),
                    createdBy: userId
                });
                document.getElementById('newClassName').value = '';
                alertModal(`Klasa "${name}" zosta≈Ça dodana!`, 'success');
            } catch (error) {
                console.error("B≈ÇƒÖd dodawania klasy:", error);
                alertModal("WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania klasy.", 'error');
            }
        };

        window.addSubjectToClass = async () => {
            if (!selectedClassId) return alertModal("Najpierw wybierz klasƒô.");
            const newSubjectName = document.getElementById('newSubjectName').value.trim();
            if (!newSubjectName) return alertModal("Podaj nazwƒô przedmiotu!");

            try {
                const classRef = doc(db, getPublicCollectionPath('classes'), selectedClassId);
                await updateDoc(classRef, {
                    subjects: arrayUnion(newSubjectName)
                });
                document.getElementById('newSubjectName').value = '';
                alertModal(`Przedmiot "${newSubjectName}" dodany do klasy.`, 'success');
            } catch (error) {
                console.error("B≈ÇƒÖd dodawania przedmiotu:", error);
                alertModal("WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania przedmiotu.", 'error');
            }
        };

        window.openAddStudentModal = () => {
             modalEl.classList.remove('hidden');
             setTimeout(() => {
                modalEl.classList.add('opacity-100');
                modalContentEl.classList.remove('scale-95', 'opacity-0');
                modalContentEl.classList.add('scale-100', 'opacity-100');
             }, 10);
        }
        window.closeAddStudentModal = () => {
             modalContentEl.classList.remove('scale-100', 'opacity-100');
             modalContentEl.classList.add('scale-95', 'opacity-0');
             setTimeout(() => {
                modalEl.classList.add('hidden');
             }, 300);
        }

        window.addStudent = async () => {
            if (!selectedClassId) return alertModal("Najpierw wybierz klasƒô.");
            const name = document.getElementById('newStudentName').value.trim();
            if (!name) return alertModal("Podaj imiƒô i nazwisko ucznia!");

            try {
                const studentsRef = collection(db, getPublicCollectionPath(`classes/${selectedClassId}/students`));
                await addDoc(studentsRef, {
                    name,
                    createdAt: serverTimestamp(),
                    createdBy: userId
                });
                document.getElementById('newStudentName').value = '';
                closeAddStudentModal();
                alertModal(`Ucze≈Ñ "${name}" zosta≈Ç dodany!`, 'success');
            } catch (error) {
                console.error("B≈ÇƒÖd dodawania ucznia:", error);
                alertModal("WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania ucznia.", 'error');
            }
        };

        window.submitGrade = async () => {
            const studentId = gradeStudentSelectorEl.value;
            const subject = gradeSubjectSelectorEl.value;
            const score = parseFloat(document.getElementById('gradeValue').value);
            const category = document.getElementById('gradeCategory').value;
            const comment = document.getElementById('gradeComment').value.trim();

            if (!studentId || !subject || isNaN(score) || score < 1 || score > 6 || !category) {
                return alertModal("Wype≈Çnij poprawnie wszystkie pola: Ucze≈Ñ, Przedmiot, Ocena (1-6) i Kategoria.");
            }

            try {
                const gradesRef = collection(db, getPublicCollectionPath(`classes/${selectedClassId}/students/${studentId}/grades`));
                await addDoc(gradesRef, {
                    score,
                    subject,
                    category,
                    comment: comment || null,
                    date: serverTimestamp(),
                    teacherId: userId
                });
                
                document.getElementById('gradeValue').value = '';
                document.getElementById('gradeCategory').value = '';
                document.getElementById('gradeComment').value = '';
                alertModal("Ocena zapisana pomy≈õlnie!", 'success');

            } catch (error) {
                console.error("B≈ÇƒÖd zapisywania oceny:", error);
                alertModal("WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisywania oceny.", 'error');
            }
        };

        window.submitNote = async () => {
            const studentId = noteStudentSelectorEl.value;
            const type = document.getElementById('noteType').value;
            const content = document.getElementById('noteContent').value.trim();

            if (!studentId || !type || !content) {
                return alertModal("Wype≈Çnij pola: Ucze≈Ñ, Typ Uwagi i Tre≈õƒá Uwagi.");
            }

            try {
                const notesRef = collection(db, getPublicCollectionPath(`classes/${selectedClassId}/students/${studentId}/notes`));
                await addDoc(notesRef, {
                    type,
                    content,
                    date: serverTimestamp(),
                    teacherId: userId
                });
                
                document.getElementById('noteContent').value = '';
                alertModal("Uwaga zapisana pomy≈õlnie!", 'success');

            } catch (error) {
                console.error("B≈ÇƒÖd zapisywania uwagi:", error);
                alertModal("WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisywania uwagi.", 'error');
            }
        };

        window.handleClassChange = (event) => {
            const newClassId = event.target.value;
            if (newClassId && newClassId !== selectedClassId) {
                selectedClassId = newClassId;
                setupClassSubscribers(selectedClassId);
                renderClassDetails();
            }
        };

        const renderClassSelector = () => {
            classSelectorEl.innerHTML = '<option value="" disabled selected>--- Wybierz Klasƒô ---</option>';
            const sortedClasses = Object.values(classes).sort((a, b) => a.name.localeCompare(b.name));
            sortedClasses.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === selectedClassId) {
                    option.selected = true;
                }
                classSelectorEl.appendChild(option);
            });
            classSelectorEl.onchange = window.handleClassChange;
        };

        const renderClassDetails = () => {
            if (!selectedClassId || !classes[selectedClassId]) {
                classDetailsEl.classList.add('hidden');
                subjectManagerEl.classList.add('hidden');
                return;
            }

            classDetailsEl.classList.remove('hidden');
            subjectManagerEl.classList.remove('hidden');

            const currentClass = classes[selectedClassId];
            selectedClassNameDisplayEl.textContent = currentClass.name;
            
            currentSubjectsEl.innerHTML = currentClass.subjects.map(sub => 
                `<span class="px-3 py-1 bg-white glass-card border-emerald-400 border text-emerald-700 text-sm font-medium rounded-full">${sub}</span>`
            ).join('');

            renderEntrySelectors();
            
            renderStudentsList();
            renderReport();
        };

        const calculateAverage = (grades) => {
            if (grades.length === 0) return 'Brak';
            const sum = grades.reduce((acc, g) => acc + g.score, 0);
            return (sum / grades.length).toFixed(2);
        };
        
        const getSubjectGrades = (studentId, subject) => {
            const currentClass = classes[selectedClassId];
            const student = currentClass?.students[studentId];
            if (!student) return [];
            return student.grades.filter(g => g.subject === subject);
        };

        const renderStudentsList = () => {
            if (!selectedClassId || !classes[selectedClassId]) return;

            const currentClass = classes[selectedClassId];
            const subjects = currentClass.subjects || [];
            const students = Object.values(currentClass.students).sort((a, b) => a.name.localeCompare(b.name));

            if (students.length === 0) {
                studentsListEl.innerHTML = '<p class="text-gray-500 p-4">Brak uczni√≥w w tej klasie. Dodaj pierwszego ucznia.</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-2xl overflow-hidden glass-card">
                    <thead class="bg-indigo-50 bg-opacity-70">
                        <tr>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider sticky left-0 bg-indigo-50 bg-opacity-70 rounded-tl-2xl">Ucze≈Ñ</th>
                            ${subjects.map(sub => `<th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">${sub}</th>`).join('')}
                            <th class="px-4 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Uwagi</th>
                            <th class="px-4 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tr-2xl">≈örednia</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            students.forEach(student => {
                let totalGrades = [];
                let subjectCells = '';

                subjects.forEach(subject => {
                    const subjectGrades = getSubjectGrades(student.id, subject);
                    totalGrades.push(...subjectGrades);
                    const avg = calculateAverage(subjectGrades);
                    
                    const gradeMarks = subjectGrades.map(g => `<span title="${g.category}${g.comment ? ': ' + g.comment : ''}" class="inline-block px-2 py-0.5 m-0.5 text-xs font-semibold rounded-full ${g.score >= 4.5 ? 'bg-yellow-400 text-gray-800' : 'bg-blue-400 text-white'}">${g.score}</span>`).join('');
                    
                    subjectCells += `<td class="px-4 py-4 text-sm text-gray-900">${gradeMarks || '<span class="text-gray-400">---</span>'}</td>`;
                });

                const totalAvg = calculateAverage(totalGrades);
                const posNotes = student.notes.filter(n => n.type === 'positive').length;
                const negNotes = student.notes.filter(n => n.type === 'negative').length;
                
                html += `
                    <tr class="hover:bg-gray-100 transition duration-150">
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 sticky left-0 glass-card">${student.name}</td>
                        ${subjectCells}
                        <td class="px-4 py-4 whitespace-nowrap text-center text-sm">
                            <span class="text-emerald-600 font-bold" title="Pozytywne Uwagi">${posNotes}</span> / 
                            <span class="text-red-600 font-bold" title="Negatywne Uwagi">${negNotes}</span>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-center text-sm font-bold text-indigo-600">${totalAvg}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            studentsListEl.innerHTML = html;
        };

        const renderEntrySelectors = () => {
             if (!selectedClassId || !classes[selectedClassId]) return;
            
            const currentClass = classes[selectedClassId];
            const subjects = currentClass.subjects || [];
            const students = Object.values(currentClass.students).sort((a, b) => a.name.localeCompare(b.name));

            const studentOptions = students.map(s => 
                `<option value="${s.id}">${s.name}</option>`
            ).join('');
            
            const subjectOptions = subjects.map(s => 
                `<option value="${s}">${s}</option>`
            ).join('');

            [gradeStudentSelectorEl, noteStudentSelectorEl, reportStudentSelectorEl].forEach(selector => {
                const selectedValue = selector.value;
                selector.innerHTML = `<option value="" disabled ${!selectedValue ? 'selected' : ''}>--- Wybierz Ucznia ---</option>` + studentOptions;
                if (selectedValue && students.find(s => s.id === selectedValue)) {
                     selector.value = selectedValue;
                }
            });

            gradeSubjectSelectorEl.innerHTML = `<option value="" disabled selected>--- Wybierz Przedmiot ---</option>` + subjectOptions;
        };

        window.renderReport = () => {
            const studentId = reportStudentSelectorEl.value;
            if (!studentId || !selectedClassId || !classes[selectedClassId]) {
                studentReportDetailsEl.innerHTML = '<p class="text-gray-500 p-4">Wybierz ucznia, aby zobaczyƒá szczeg√≥≈Çy.</p>';
                return;
            }

            const currentClass = classes[selectedClassId];
            const student = currentClass.students[studentId];

            if (!student) return;

            const gradesBySubject = student.grades.reduce((acc, grade) => {
                acc[grade.subject] = acc[grade.subject] || [];
                acc[grade.subject].push(grade);
                return acc;
            }, {});

            let gradesHtml = '<div class="p-6 glass-card border border-emerald-400 bg-emerald-50 bg-opacity-70 shadow-lg"><h5 class="text-2xl font-bold mb-4 text-emerald-800 border-b pb-2">Historia Ocen</h5>';
            
            const sortedSubjects = Object.keys(gradesBySubject).sort();
            if (sortedSubjects.length > 0) {
                sortedSubjects.forEach(subject => {
                    const subjectGrades = gradesBySubject[subject].sort((a, b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0));
                    gradesHtml += `<h6 class="font-bold text-emerald-600 mt-5 mb-3 text-lg">${subject} <span class="text-sm font-medium text-gray-600">(≈örednia: ${calculateAverage(subjectGrades)})</span></h6><div class="space-y-3">`;
                    subjectGrades.forEach(g => {
                        const date = g.date ? new Date(g.date.toMillis()).toLocaleDateString('pl-PL') : 'N/A';
                        gradesHtml += `
                            <div class="p-4 bg-white rounded-xl border-l-4 border-emerald-500 flex justify-between items-start shadow-sm">
                                <div>
                                    <span class="text-3xl font-extrabold text-emerald-800 mr-3">${g.score}</span>
                                    <span class="text-sm font-medium text-gray-700">(${g.category})</span>
                                    ${g.comment ? `<p class="text-xs italic text-gray-600 mt-1">Komentarz: ${g.comment}</p>` : ''}
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Data: ${date}</p>
                            </div>
                        `;
                    });
                    gradesHtml += '</div>';
                });
            } else {
                 gradesHtml += '<p class="text-gray-500 p-4">Brak ocen.</p>';
            }
            gradesHtml += '</div>';

            let notesHtml = '<div class="p-6 glass-card border border-indigo-400 bg-indigo-50 bg-opacity-70 shadow-lg"><h5 class="text-2xl font-bold mb-4 text-indigo-800 border-b pb-2">Historia Uwag</h5><div class="space-y-3">';
            student.notes.sort((a, b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0)).forEach(n => {
                const date = n.date ? new Date(n.date.toMillis()).toLocaleDateString('pl-PL') : 'N/A';
                const color = n.type === 'positive' ? 'emerald' : 'red';
                const icon = n.type === 'positive' ? '‚úÖ' : '‚ùå';
                notesHtml += `
                    <div class="p-4 bg-white border-l-4 border-${color}-500 rounded-xl flex items-start justify-between shadow-sm">
                        <div>
                            <span class="font-semibold text-${color}-800">${icon} ${n.type === 'positive' ? 'Pozytywna' : 'Negatywna'}</span>
                            <p class="text-sm mt-1 text-gray-700">${n.content}</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 whitespace-nowrap">Data: ${date}</p>
                    </div>
                `;
            });
            notesHtml += student.notes.length === 0 ? '<p class="text-gray-500 p-4">Brak uwag.</p>' : '';
            notesHtml += '</div></div>';
            
            let html = `
                <h4 class="text-3xl font-bold mb-8 text-gray-800 border-b-2 border-indigo-500 pb-2">${student.name}</h4>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    ${gradesHtml}
                    ${notesHtml}
                </div>
            `;

            studentReportDetailsEl.innerHTML = html;
        };

        window.showTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                 el.classList.remove('active', 'bg-white', 'text-indigo-600', 'text-gray-800');
                 el.classList.add('bg-transparent', 'text-gray-600');
            });

            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            activeBtn.classList.add('active', 'text-indigo-600');
            activeBtn.classList.remove('bg-transparent', 'text-gray-600');
            
            if (tabName === 'entry' || tabName === 'reports') {
                renderEntrySelectors();
                if (tabName === 'reports') {
                    window.renderReport();
                    reportStudentSelectorEl.onchange = window.renderReport;
                }
            }
        };
        
        window.onload = () => {
            showTab('students');
        };

        const alertModal = (message, type = 'info') => {
            const colors = {
                info: 'bg-blue-600',
                success: 'bg-emerald-600',
                error: 'bg-red-600'
            };
            
            let modal = document.getElementById('customAlert');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customAlert';
                modal.className = 'fixed top-6 right-6 z-[9999] p-4 text-white rounded-xl shadow-2xl transition-all duration-300 opacity-0 transform translate-y-4';
                document.body.appendChild(modal);
            }

            modal.className = `fixed top-6 right-6 z-[9999] p-4 text-white rounded-xl shadow-2xl transition-all duration-300 ${colors[type]}`;
            modal.textContent = message;
            
            setTimeout(() => modal.classList.remove('opacity-0', 'translate-y-4'), 10);
            
            setTimeout(() => {
                 modal.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        };

        initializeFirebase();
    </script>
</body>
</html>
